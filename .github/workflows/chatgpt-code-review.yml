name: ChatGPT Inline Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  code_review:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'

    - name: Install Dependencies
      run: npm install openai @octokit/rest@18.12.0

    - name: Fetch PR Diff
      id: get_diff
      run: |
        git fetch origin ${{ github.event.pull_request.base.ref }}
        git diff origin/${{ github.event.pull_request.base.ref }} > pr_diff.txt

    - name: Run ChatGPT Inline Review
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Create the review script
        cat <<'EOF' > review.js
        const fs = require('fs');
        const { OpenAI } = require('openai');
        const { Octokit } = require('@octokit/rest');

        const openai = new OpenAI({
          apiKey: process.env.OPENAI_API_KEY,
        });

        const octokit = new Octokit({ auth: process.env.GITHUB_TOKEN });

        async function reviewDiff() {
          try {
            const diff = fs.readFileSync('pr_diff.txt', 'utf8');
            const [owner, repo] = process.env.GITHUB_REPOSITORY.split('/');
            const pull_number = parseInt(process.env.GITHUB_REF_NAME.split('/')[2], 10);
            const commit_id = process.env.GITHUB_SHA;

            // Parse the diff into file changes
            const changes = diff.split('diff --git').slice(1).map(change => {
              const lines = change.split('\n');
              const filePathMatch = lines[0].match(/b\/([\w\d_./]+)/);
              const filePath = filePathMatch ? filePathMatch[1] : null;

              const header = lines.find(line => line.startsWith('@@'));
              const lineMatch = header ? header.match(/\+(\d+)/) : null;
              const addedStart = lineMatch ? parseInt(lineMatch[1], 10) : null;

              const addedLines = lines.filter(line => line.startsWith('+') && !line.startsWith('+++')).map(line => line.slice(1));

              return { filePath, addedStart, addedLines };
            }).filter(change => change.filePath && change.addedLines.length > 0);

            console.log('Parsed changes:', changes);

            for (const { filePath, addedStart, addedLines } of changes) {
              if (!filePath || addedLines.length === 0) {
                continue;
              }

              const prompt = `
                Review the following changes in the file \`${filePath}\`:
                ${addedLines.join('\n')}
                
                Provide feedback and suggestions for improvements, considering the coding standards and logic.
              `;

              console.log('Generated prompt:', prompt);

              const promptTokenEstimate = Math.min(prompt.split(/\s+/).length * 2, 4000);
              const maxTokens = Math.max(1000, 4096 - promptTokenEstimate);

              const response = await openai.chat.completions.create({
                model: 'gpt-4',
                messages: [{ role: 'user', content: prompt }],
                max_tokens: maxTokens,
                n: 1,
              });

              if (!response || !response.data || !response.data.choices || response.data.choices.length === 0 || !response.data.choices[0].message) {
                console.error('Invalid or empty response from OpenAI API:', JSON.stringify(response, null, 2));
                continue;
              }

              const feedback = response.data.choices[0].message.content;

              console.log('Posting inline comment:', {
                filePath,
                addedStart,
                feedback,
              });

              try {
                await octokit.pulls.createReviewComment({
                  owner,
                  repo,
                  pull_number,
                  body: feedback,
                  commit_id,
                  path: filePath,
                  line: addedStart,
                });
              } catch (err) {
                console.error(`Failed to post comment for ${filePath}:${addedStart}`, err.message);
              }
            }
          } catch (error) {
            console.error('Error during ChatGPT review:', error.message || error);
            process.exit(1);
          }
        }

        reviewDiff();
        EOF

        node review.js
